#!/usr/bin/env groovy

pipeline {
    agent any
    environment {
        AWS_ACCESS_KEY = credentials('JenkinsUser')
        //GOLD_AWS = credentials('goldkey')

        AWS_DEFAULT_REGION = 'us-east-1'
        AWS_ACCESS_KEY_ID = "${AWS_ACCESS_KEY_USR}"
        AWS_SECRET_ACCESS_KEY = "${AWS_ACCESS_KEY_PSW}"
    }
    stages {
      stage("Retrieve SMTP's IP Address New") {
          steps {
            script {
                dir('test-instance') {
                    sh """
                    set -e +x
                    smtp_ip=\$(/usr/local/bin/aws ec2 describe-instances --instance-ids $OLD_SMTP_1 \
                      --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)
                      echo $smtp_ip
                      """
              }
          }
      }
  }
      stage("Retrieve SMTP's IP Address") {
          steps {
            script {
                dir('test-instance') {
                    sh """
                    sh ./decom_smtp1.sh '${OLD_SMTP_1}' /
                    SMTP_IP = sh script:script_string, returnStdout: true
                    echo SMTP_IP
                    """
              }
          }
      }
  }
        stage('Decommission Old SMTP Server') {
          steps {
              script {
                  retry(3){
                      withCredentials([sshUserPrivateKey(credentialsId: 'goldkey', keyFileVariable: 'sshkey', passphraseVariable: 'sshpassphrase', usernameVariable: 'sshusername')]) {
                          sh """
                          set -e +x
                          echo "Checking mailq "
                          ssh -tt -o StrictHostKeyChecking=no -i $sshkey $sshusername@${SMTP_IP} "sudo bash -c '/root/ssm/inventory/ssmec2minioncheck.sh ${params.AWS_ACCOUNT_ID} ${params.SALT_ACCOUNT_NAME}'"
                          ssh -tt -o StrictHostKeyChecking=no -i $sshkey $sshusername@${params.SMTP_IP} "sudo bash -c '/root/ssm/inventory/iamvalidate.sh ${params.AWS_ACCOUNT_ID} > /dev/null 2>&1 >/root/ssm/inventory/${AWS_ACCOUNT_ID}.txt'"
                          ssh -tt -o StrictHostKeyChecking=no -i $sshkey $sshusername@${params.SMTP_IP} "sudo cat /root/ssm/inventory/${AWS_ACCOUNT_ID}.txt"
                          """
                      }
                  }
              }
           }
        }
    }
}
